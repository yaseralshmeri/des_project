const UniversitySystem = { config: { apiBaseUrl: '/api/v1/', refreshInterval: 30000, animationDuration: 300, debounceDelay: 500, }, cache: new Map(), utils: { debounce: function(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }, formatNumber: function(number) { return new Intl.NumberFormat('ar-SA').format(number); }, formatDate: function(date) { return new Intl.DateTimeFormat('ar-SA', { year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(date)); }, showLoading: function(element) { const loader = '<div class="d-flex justify-content-center py-3"><div class="loading"></div></div>'; $(element).html(loader); }, showToast: function(message, type = 'info', duration = 5000) { const toastId = 'toast-' + Date.now(); const toastHtml = ` <div class="toast align-items-center text-white bg-${type} border-0" role="alert" id="${toastId}"> <div class="d-flex"> <div class="toast-body">${message}</div> <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button> </div> </div> `; if (!$('#toast-container').length) { $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>'); } $('#toast-container').append(toastHtml); const toast = new bootstrap.Toast(document.getElementById(toastId), { delay: duration }); toast.show(); $('#' + toastId).on('hidden.bs.toast', function() { $(this).remove(); }); }, apiRequest: function(url, options = {}) { const defaultOptions = { method: 'GET', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || '', }, }; const finalOptions = { ...defaultOptions, ...options }; return fetch(url, finalOptions) .then(response => { if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } return response.json(); }) .catch(error => { console.error('API Request Error:', error); UniversitySystem.utils.showToast('حدث خطأ في الاتصال بالخادم', 'danger'); throw error; }); } } }; $(document).ready(function() { initializeSystem(); }); function initializeSystem() { setupNavigationEnhancements(); setupNotificationSystem(); setupSearchFunctionality(); setupFormEnhancements(); setupTableEnhancements(); setupDashboardRefresh(); setupAnimations(); setupTooltips(); setupResponsiveEnhancements(); } function setupNavigationEnhancements() { $('a[href^="#"]').on('click', function(event) { const target = $(this.getAttribute('href')); if (target.length) { event.preventDefault(); $('html, body').stop().animate({ scrollTop: target.offset().top - 80 }, 800, 'easeInOutExpo'); } }); const currentPath = window.location.pathname; $('.nav-link').each(function() { const href = $(this).attr('href'); if (href && currentPath.includes(href) && href !== '/') { $(this).addClass('active'); } }); let lastScrollTop = 0; $(window).scroll(function() { const scrollTop = $(this).scrollTop(); const navbar = $('.navbar'); if (scrollTop > 100) { navbar.addClass('navbar-scrolled'); } else { navbar.removeClass('navbar-scrolled'); } if ($(window).width() <= 768) { if (scrollTop > lastScrollTop && scrollTop > 200) { navbar.addClass('navbar-hidden'); } else { navbar.removeClass('navbar-hidden'); } } lastScrollTop = scrollTop; }); } function setupNotificationSystem() { $(document).on('show.bs.dropdown', '.notification-dropdown', function() { loadNotifications(); }); $(document).on('click', '.notification-item', function() { const notificationId = $(this).data('id'); if (notificationId) { markNotificationAsRead(notificationId); } }); setInterval(refreshNotificationCount, UniversitySystem.config.refreshInterval); } function loadNotifications() { const container = $('#notifications-list'); UniversitySystem.utils.showLoading(container); UniversitySystem.utils.apiRequest('/api/notifications/') .then(data => { if (data.success) { displayNotifications(data.notifications); } else { container.html('<div class="text-center text-muted py-3">لا توجد إشعارات</div>'); } }) .catch(error => { container.html('<div class="text-center text-danger py-3">خطأ في تحميل الإشعارات</div>'); }); } function displayNotifications(notifications) { const container = $('#notifications-list'); if (!notifications || notifications.length === 0) { container.html('<div class="text-center text-muted py-3">لا توجد إشعارات جديدة</div>'); return; } let html = ''; notifications.forEach(notification => { const timeAgo = getTimeAgo(notification.created_at); const iconClass = getNotificationIcon(notification.type); html += ` <div class="notification-item border-bottom py-2" data-id="${notification.id}"> <div class="d-flex"> <div class="flex-shrink-0"> <i class="fas ${iconClass} text-primary"></i> </div> <div class="flex-grow-1 ms-2"> <small class="text-muted">${timeAgo}</small> <p class="mb-1">${notification.message}</p> </div> </div> </div> `; }); container.html(html); } function markNotificationAsRead(notificationId) { UniversitySystem.utils.apiRequest(`/api/notifications/${notificationId}/read/`, { method: 'POST' }).then(data => { if (data.success) { updateNotificationCount(); } }); } function refreshNotificationCount() { UniversitySystem.utils.apiRequest('/api/notifications/count/') .then(data => { if (data.success) { $('#notification-count').text(data.count); if (data.count > 0) { $('#notification-count').show(); } else { $('#notification-count').hide(); } } }) .catch(error => { console.error('Failed to refresh notification count:', error); }); } function setupSearchFunctionality() { const searchInput = $('#global-search'); const searchResults = $('#search-results'); if (searchInput.length) { const debouncedSearch = UniversitySystem.utils.debounce(performSearch, UniversitySystem.config.debounceDelay); searchInput.on('input', function() { const query = $(this).val().trim(); if (query.length >= 2) { debouncedSearch(query); } else { hideSearchResults(); } }); $(document).on('click', function(e) { if (!$(e.target).closest('#search-container').length) { hideSearchResults(); } }); } } function performSearch(query) { const searchResults = $('#search-results'); searchResults.show(); UniversitySystem.utils.showLoading(searchResults); UniversitySystem.utils.apiRequest(`/api/search/?q=${encodeURIComponent(query)}`) .then(data => { if (data.success) { displaySearchResults(data.results); } else { searchResults.html('<div class="text-center text-muted py-3">لا توجد نتائج</div>'); } }) .catch(error => { searchResults.html('<div class="text-center text-danger py-3">خطأ في البحث</div>'); }); } function displaySearchResults(results) { const container = $('#search-results'); if (!results || results.length === 0) { container.html('<div class="text-center text-muted py-3">لا توجد نتائج</div>'); return; } let html = '<div class="list-group list-group-flush">'; results.forEach(result => { const iconClass = getResultIcon(result.type); html += ` <a href="${result.url}" class="list-group-item list-group-item-action"> <div class="d-flex align-items-center"> <i class="fas ${iconClass} me-2 text-primary"></i> <div> <div class="fw-bold">${result.title}</div> <small class="text-muted">${result.subtitle}</small> </div> </div> </a> `; }); html += '</div>'; container.html(html); } function hideSearchResults() { $('#search-results').hide(); } function setupFormEnhancements() { $('.form-control').on('blur', function() { validateField($(this)); }); $('form').on('submit', function() { const submitBtn = $(this).find('button[type="submit"]'); const originalText = submitBtn.html(); submitBtn.prop('disabled', true) .html('<i class="fas fa-spinner fa-spin me-2"></i>جاري المعالجة...'); setTimeout(() => { submitBtn.prop('disabled', false).html(originalText); }, 30000); }); $('form[data-autosave]').each(function() { setupAutoSave($(this)); }); $('input[type="password"]').on('input', function() { const password = $(this).val(); const strength = calculatePasswordStrength(password); displayPasswordStrength($(this), strength); }); } function validateField(field) { const value = field.val().trim(); const rules = field.data('validate'); if (!rules) return; let isValid = true; let errorMessage = ''; if (rules.includes('required') && !value) { isValid = false; errorMessage = 'هذا الحقل مطلوب'; } if (rules.includes('email') && value && !isValidEmail(value)) { isValid = false; errorMessage = 'يرجى إدخال بريد إلكتروني صحيح'; } if (rules.includes('phone') && value && !isValidPhone(value)) { isValid = false; errorMessage = 'يرجى إدخال رقم هاتف صحيح'; } displayFieldValidation(field, isValid, errorMessage); } function displayFieldValidation(field, isValid, errorMessage) { field.removeClass('is-valid is-invalid'); field.siblings('.invalid-feedback').remove(); if (isValid) { field.addClass('is-valid'); } else { field.addClass('is-invalid'); field.after(`<div class="invalid-feedback">${errorMessage}</div>`); } } function setupTableEnhancements() { $('.table-sortable th[data-sort]').on('click', function() { const column = $(this).data('sort'); const table = $(this).closest('table'); sortTable(table, column); }); $('.table-selectable').each(function() { setupTableSelection($(this)); }); $('.table-responsive').each(function() { enhanceResponsiveTable($(this)); }); $('.btn-export').on('click', function() { const format = $(this).data('format'); const table = $(this).data('table'); exportTable(table, format); }); } function setupDashboardRefresh() { if ($('.dashboard-stat').length) { setInterval(refreshDashboardStats, 300000); animateDashboardStats(); } } function refreshDashboardStats() { UniversitySystem.utils.apiRequest('/api/dashboard-stats/') .then(data => { if (data.success) { updateDashboardStats(data.stats); } }) .catch(error => { console.error('Failed to refresh dashboard stats:', error); }); } function updateDashboardStats(stats) { Object.keys(stats).forEach(key => { const element = $(`#${key}`); if (element.length) { const currentValue = parseInt(element.text().replace(/[^\d]/g, '')); const newValue = stats[key]; if (currentValue !== newValue) { animateNumber(element, newValue); } } }); } function animateDashboardStats() { $('.dashboard-stat h3').each(function() { const element = $(this); const finalValue = parseInt(element.text().replace(/[^\d]/g, '')); if (finalValue) { element.text('0'); animateNumber(element, finalValue, 2000); } }); } function animateNumber(element, targetNumber, duration = 1000) { $({ counter: 0 }).animate({ counter: targetNumber }, { duration: duration, easing: 'swing', step: function() { element.text(UniversitySystem.utils.formatNumber(Math.ceil(this.counter))); }, complete: function() { element.text(UniversitySystem.utils.formatNumber(targetNumber)); } }); } function setupAnimations() { const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' }; const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('animate-in'); } }); }, observerOptions); document.querySelectorAll('.fade-up, .slide-in-left, .slide-in-right').forEach(el => { observer.observe(el); }); $('.card').hover( function() { $(this).addClass('card-hover'); }, function() { $(this).removeClass('card-hover'); } ); $('.btn').on('click', function(e) { const btn = $(this); const ripple = $('<span class="btn-ripple"></span>'); btn.append(ripple); const x = e.pageX - btn.offset().left; const y = e.pageY - btn.offset().top; ripple.css({ left: x + 'px', top: y + 'px' }).addClass('ripple-animate'); setTimeout(() => ripple.remove(), 600); }); } function setupTooltips() { const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')); tooltipTriggerList.map(function(tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); }); const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]')); popoverTriggerList.map(function(popoverTriggerEl) { return new bootstrap.Popover(popoverTriggerEl); }); } function setupResponsiveEnhancements() { $('.navbar-toggler').on('click', function() { $(this).toggleClass('active'); }); $(window).on('resize', function() { handleResponsiveTables(); }); if ('ontouchstart' in window) { setupTouchGestures(); } handleResponsiveTables(); } function handleResponsiveTables() { $('.table-responsive').each(function() { const table = $(this); const windowWidth = $(window).width(); if (windowWidth < 768) { table.addClass('table-mobile'); } else { table.removeClass('table-mobile'); } }); } function getTimeAgo(dateString) { const date = new Date(dateString); const now = new Date(); const diffInSeconds = Math.floor((now - date) / 1000); if (diffInSeconds < 60) return 'منذ لحظات'; if (diffInSeconds < 3600) return `منذ ${Math.floor(diffInSeconds / 60)} دقيقة`; if (diffInSeconds < 86400) return `منذ ${Math.floor(diffInSeconds / 3600)} ساعة`; return `منذ ${Math.floor(diffInSeconds / 86400)} يوم`; } function getNotificationIcon(type) { const icons = { 'info': 'fa-info-circle', 'success': 'fa-check-circle', 'warning': 'fa-exclamation-triangle', 'error': 'fa-times-circle', 'grade': 'fa-chart-bar', 'payment': 'fa-credit-card', 'assignment': 'fa-tasks' }; return icons[type] || 'fa-bell'; } function getResultIcon(type) { const icons = { 'user': 'fa-user', 'course': 'fa-book', 'department': 'fa-building', 'payment': 'fa-credit-card' }; return icons[type] || 'fa-search'; } function isValidEmail(email) { const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return emailRegex.test(email); } function isValidPhone(phone) { const phoneRegex = /^(\+966|966|0)?[5][0-9]{8}$/; return phoneRegex.test(phone.replace(/\s/g, '')); } function calculatePasswordStrength(password) { let strength = 0; if (password.length >= 8) strength += 1; if (/[a-z]/.test(password)) strength += 1; if (/[A-Z]/.test(password)) strength += 1; if (/[0-9]/.test(password)) strength += 1; if (/[^A-Za-z0-9]/.test(password)) strength += 1; return strength; } function displayPasswordStrength(field, strength) { const strengthLabels = ['ضعيف جداً', 'ضعيف', 'متوسط', 'قوي', 'قوي جداً']; const strengthColors = ['danger', 'warning', 'info', 'success', 'success']; let indicator = field.siblings('.password-strength'); if (!indicator.length) { field.after('<div class="password-strength mt-1"></div>'); indicator = field.siblings('.password-strength'); } const strengthClass = strengthColors[strength - 1] || 'secondary'; const strengthLabel = strengthLabels[strength - 1] || ''; indicator.html(` <div class="progress" style="height: 5px;"> <div class="progress-bar bg-${strengthClass}" style="width: ${(strength / 5) * 100}%"></div> </div> <small class="text-${strengthClass}">${strengthLabel}</small> `); } $.easing.easeInOutExpo = function (x, t, b, c, d) { if (t==0) return b; if (t==d) return b+c; if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b; return c/2 * (-Math.pow(2, -10 * --t) + 2) + b; }; window.UniversitySystem = UniversitySystem;