class UniversitySystemApp { constructor() { this.init(); } init() { this.setupEventListeners(); this.initializeComponents(); this.setupFormValidation(); this.setupNotifications(); this.setupLoadingStates(); this.setupAccessibility(); } setupEventListeners() { document.addEventListener('DOMContentLoaded', () => { this.onDOMReady(); }); window.addEventListener('load', () => { this.onPageLoad(); }); window.addEventListener('resize', this.debounce(() => { this.onWindowResize(); }, 300)); window.addEventListener('beforeunload', (e) => { this.onBeforeUnload(e); }); } onDOMReady() { this.initializeSidebar(); this.initializeTooltips(); this.initializePopovers(); this.initializeModals(); this.initializeTables(); this.initializeCharts(); this.animateElements(); } onPageLoad() { this.hideLoadingSpinner(); this.initializeRealTimeUpdates(); this.setupPerformanceOptimizations(); } onWindowResize() { this.adjustSidebarForMobile(); this.resizeCharts(); } onBeforeUnload(e) { const hasUnsavedChanges = this.checkUnsavedChanges(); if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = 'لديك تغييرات غير محفوظة. هل أنت متأكد من المغادرة؟'; return e.returnValue; } } initializeSidebar() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('overlay'); const navbarToggler = document.querySelector('.navbar-toggler'); if (!sidebar || !overlay || !navbarToggler) return; navbarToggler.addEventListener('click', () => { sidebar.classList.toggle('show'); overlay.classList.toggle('show'); document.body.classList.toggle('sidebar-open'); }); overlay.addEventListener('click', () => { sidebar.classList.remove('show'); overlay.classList.remove('show'); document.body.classList.remove('sidebar-open'); }); this.highlightActiveNavLink(); } highlightActiveNavLink() { const currentPath = window.location.pathname; const navLinks = document.querySelectorAll('.sidebar .nav-link'); navLinks.forEach(link => { const href = link.getAttribute('href'); if (href && currentPath.startsWith(href)) { link.classList.add('active'); } else { link.classList.remove('active'); } }); } initializeTooltips() { const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')); tooltipTriggerList.map(tooltipTriggerEl => { return new bootstrap.Tooltip(tooltipTriggerEl, { placement: 'top', trigger: 'hover focus' }); }); } initializePopovers() { const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]')); popoverTriggerList.map(popoverTriggerEl => { return new bootstrap.Popover(popoverTriggerEl); }); } initializeModals() { const modals = document.querySelectorAll('.modal'); modals.forEach(modal => { modal.addEventListener('show.bs.modal', (e) => { this.onModalShow(e); }); modal.addEventListener('hidden.bs.modal', (e) => { this.onModalHide(e); }); }); } onModalShow(e) { const modal = e.target; const firstInput = modal.querySelector('input, select, textarea'); if (firstInput) { setTimeout(() => firstInput.focus(), 100); } } onModalHide(e) { const modal = e.target; const forms = modal.querySelectorAll('form'); forms.forEach(form => { if (!form.classList.contains('keep-data')) { form.reset(); } }); } initializeTables() { const tables = document.querySelectorAll('.table'); tables.forEach(table => { this.enhanceTable(table); }); } enhanceTable(table) { const rows = table.querySelectorAll('tbody tr'); rows.forEach(row => { row.addEventListener('mouseenter', () => { row.style.transform = 'scale(1.02)'; }); row.addEventListener('mouseleave', () => { row.style.transform = 'scale(1)'; }); }); this.addTableSorting(table); } addTableSorting(table) { const headers = table.querySelectorAll('thead th[data-sortable]'); headers.forEach(header => { header.style.cursor = 'pointer'; header.innerHTML += ' <i class="bi bi-arrow-down-up text-muted"></i>'; header.addEventListener('click', () => { this.sortTable(table, header); }); }); } sortTable(table, header) { const tbody = table.querySelector('tbody'); const rows = Array.from(tbody.querySelectorAll('tr')); const columnIndex = Array.from(header.parentNode.children).indexOf(header); const isAscending = !header.classList.contains('sort-asc'); rows.sort((a, b) => { const aVal = a.children[columnIndex].textContent.trim(); const bVal = b.children[columnIndex].textContent.trim(); if (isAscending) { return aVal.localeCompare(bVal, 'ar'); } else { return bVal.localeCompare(aVal, 'ar'); } }); table.querySelectorAll('thead th').forEach(th => { th.classList.remove('sort-asc', 'sort-desc'); }); header.classList.add(isAscending ? 'sort-asc' : 'sort-desc'); rows.forEach(row => tbody.appendChild(row)); } initializeCharts() { if (typeof Chart === 'undefined') return; Chart.defaults.font.family = 'Cairo, Noto Sans Arabic, sans-serif'; Chart.defaults.font.size = 12; Chart.defaults.plugins.legend.rtl = true; Chart.defaults.plugins.legend.textDirection = 'rtl'; } resizeCharts() { if (typeof Chart === 'undefined') return; Chart.helpers.each(Chart.instances, (instance) => { instance.resize(); }); } setupFormValidation() { const forms = document.querySelectorAll('form[data-validate]'); forms.forEach(form => { this.enhanceForm(form); }); } enhanceForm(form) { const inputs = form.querySelectorAll('input, select, textarea'); inputs.forEach(input => { input.addEventListener('blur', () => { this.validateField(input); }); input.addEventListener('input', () => { this.clearFieldError(input); }); }); form.addEventListener('submit', (e) => { if (!this.validateForm(form)) { e.preventDefault(); e.stopPropagation(); } else { this.showLoadingSpinner(); } }); } validateField(field) { const value = field.value.trim(); const required = field.hasAttribute('required'); const type = field.getAttribute('type'); let isValid = true; let errorMessage = ''; if (required && !value) { isValid = false; errorMessage = 'هذا الحقل مطلوب'; } if (type === 'email' && value && !this.isValidEmail(value)) { isValid = false; errorMessage = 'يرجى إدخال عنوان بريد إلكتروني صحيح'; } if (type === 'tel' && value && !this.isValidPhone(value)) { isValid = false; errorMessage = 'يرجى إدخال رقم هاتف صحيح'; } const customValidator = field.getAttribute('data-validator'); if (customValidator && window[customValidator]) { const result = window[customValidator](value); if (!result.valid) { isValid = false; errorMessage = result.message; } } this.setFieldValidationState(field, isValid, errorMessage); return isValid; } setFieldValidationState(field, isValid, errorMessage = '') { const fieldGroup = field.closest('.form-group') || field.parentNode; field.classList.remove('is-valid', 'is-invalid'); field.classList.add(isValid ? 'is-valid' : 'is-invalid'); const existingError = fieldGroup.querySelector('.invalid-feedback'); if (existingError) { existingError.remove(); } if (!isValid && errorMessage) { const errorElement = document.createElement('div'); errorElement.className = 'invalid-feedback'; errorElement.textContent = errorMessage; fieldGroup.appendChild(errorElement); } } clearFieldError(field) { field.classList.remove('is-invalid'); const fieldGroup = field.closest('.form-group') || field.parentNode; const errorElement = fieldGroup.querySelector('.invalid-feedback'); if (errorElement) { errorElement.remove(); } } validateForm(form) { const fields = form.querySelectorAll('input, select, textarea'); let isValid = true; fields.forEach(field => { if (!this.validateField(field)) { isValid = false; } }); return isValid; } isValidEmail(email) { const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; return emailRegex.test(email); } isValidPhone(phone) { const phoneRegex = /^(\+966|0)?[5-9]\d{8}$/; return phoneRegex.test(phone.replace(/\s+/g, '')); } setupNotifications() { this.notifications = []; this.createNotificationContainer(); this.setupAutoHideAlerts(); } createNotificationContainer() { if (document.getElementById('notification-container')) return; const container = document.createElement('div'); container.id = 'notification-container'; container.className = 'position-fixed top-0 start-0 p-3'; container.style.zIndex = '9999'; document.body.appendChild(container); } showNotification(message, type = 'info', duration = 5000) { const notification = this.createNotificationElement(message, type); const container = document.getElementById('notification-container'); container.appendChild(notification); setTimeout(() => { notification.classList.add('show'); }, 100); if (duration > 0) { setTimeout(() => { this.hideNotification(notification); }, duration); } return notification; } createNotificationElement(message, type) { const notification = document.createElement('div'); notification.className = `alert alert-${type} alert-dismissible fade`; notification.setAttribute('role', 'alert'); const icons = { success: 'check-circle-fill', danger: 'exclamation-triangle-fill', warning: 'exclamation-circle-fill', info: 'info-circle-fill' }; notification.innerHTML = ` <i class="bi bi-${icons[type] || icons.info} me-2"></i> ${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button> `; return notification; } hideNotification(notification) { notification.classList.remove('show'); setTimeout(() => { if (notification.parentNode) { notification.parentNode.removeChild(notification); } }, 150); } setupAutoHideAlerts() { const alerts = document.querySelectorAll('.alert:not(.alert-danger)'); alerts.forEach(alert => { setTimeout(() => { if (alert.parentNode) { alert.classList.remove('show'); setTimeout(() => alert.remove(), 150); } }, 5000); }); } setupLoadingStates() { this.loadingSpinner = document.getElementById('loadingSpinner'); this.setupFormLoadingStates(); } showLoadingSpinner() { if (this.loadingSpinner) { this.loadingSpinner.classList.add('show'); } } hideLoadingSpinner() { if (this.loadingSpinner) { this.loadingSpinner.classList.remove('show'); } } setupFormLoadingStates() { const forms = document.querySelectorAll('form'); forms.forEach(form => { form.addEventListener('submit', () => { const submitBtn = form.querySelector('button[type="submit"]'); if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>جاري المعالجة...'; } }); }); } animateElements() { const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('fade-in-up'); } }); }); const animatedElements = document.querySelectorAll('.card, .stats-card, .table'); animatedElements.forEach(el => observer.observe(el)); } setupAccessibility() { this.setupKeyboardNavigation(); this.setupFocusManagement(); this.setupScreenReaderSupport(); } setupKeyboardNavigation() { document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { const openModal = document.querySelector('.modal.show'); if (openModal) { const modalInstance = bootstrap.Modal.getInstance(openModal); modalInstance.hide(); } const sidebar = document.getElementById('sidebar'); if (sidebar && sidebar.classList.contains('show')) { sidebar.classList.remove('show'); document.getElementById('overlay').classList.remove('show'); } } }); } setupFocusManagement() { const modals = document.querySelectorAll('.modal'); modals.forEach(modal => { modal.addEventListener('shown.bs.modal', () => { this.trapFocus(modal); }); }); } trapFocus(element) { const focusableElements = element.querySelectorAll( 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])' ); const firstElement = focusableElements[0]; const lastElement = focusableElements[focusableElements.length - 1]; element.addEventListener('keydown', (e) => { if (e.key === 'Tab') { if (e.shiftKey) { if (document.activeElement === firstElement) { lastElement.focus(); e.preventDefault(); } } else { if (document.activeElement === lastElement) { firstElement.focus(); e.preventDefault(); } } } }); } setupScreenReaderSupport() { const pageTitle = document.title; this.announceToScreenReader(`تم تحميل صفحة ${pageTitle}`); } announceToScreenReader(message) { const announcement = document.createElement('div'); announcement.setAttribute('aria-live', 'polite'); announcement.setAttribute('aria-atomic', 'true'); announcement.className = 'sr-only'; announcement.textContent = message; document.body.appendChild(announcement); setTimeout(() => { document.body.removeChild(announcement); }, 1000); } initializeRealTimeUpdates() { setInterval(() => { this.updateNotificationsBadge(); this.updateSystemStatus(); }, 30000); } updateNotificationsBadge() { const badge = document.querySelector('.sidebar .nav-link .badge'); if (badge) { const currentCount = parseInt(badge.textContent) || 0; if (Math.random() > 0.8) { badge.textContent = currentCount + 1; badge.classList.add('pulse'); setTimeout(() => badge.classList.remove('pulse'), 2000); } } } updateSystemStatus() { const statusBadges = document.querySelectorAll('.badge:contains("النظام يعمل")'); statusBadges.forEach(badge => { badge.classList.add('pulse'); setTimeout(() => badge.classList.remove('pulse'), 1000); }); } setupPerformanceOptimizations() { this.lazyLoadImages(); this.debounceResizeEvents(); } lazyLoadImages() { const images = document.querySelectorAll('img[data-src]'); const imageObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { const img = entry.target; img.src = img.dataset.src; img.removeAttribute('data-src'); imageObserver.unobserve(img); } }); }); images.forEach(img => imageObserver.observe(img)); } debounceResizeEvents() { let resizeTimer; window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(() => { this.onWindowResize(); }, 250); }); } adjustSidebarForMobile() { const sidebar = document.getElementById('sidebar'); if (window.innerWidth >= 768) { sidebar.classList.remove('show'); document.getElementById('overlay').classList.remove('show'); } } checkUnsavedChanges() { const forms = document.querySelectorAll('form[data-check-changes]'); return Array.from(forms).some(form => { const formData = new FormData(form); return Array.from(formData.entries()).length > 0; }); } debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; } } const app = new UniversitySystemApp(); window.UniversitySystem = app;